<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Audio Transcriber</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f4f7f6;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    header {
      text-align: center;
      padding: 20px 0;
    }
    header h1 {
      margin: 0;
      font-size: 2.5rem;
      color: #007BFF;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .card {
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .card h2 {
      margin-top: 0;
      color: #007BFF;
    }
    form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
    form label {
      font-weight: 500;
    }
    /* Set a consistent width for file and text inputs */
    form input[type="file"],
    form input[type="text"] {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      width: 100%; /* Adjust width as needed */
      max-width: 760px; /* Set a max width for larger screens */
      background-color: #fff;
      appearance: none; /* Removes default dropdown arrow in some browsers (optional) */
      box-sizing: border-box;
    }
    form select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      width: 100%;
      max-width: 760px;
      background-color: #fff;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D'12'%20height%3D'12'%20viewBox%3D'0%200%2012%2012'%20xmlns%3D'http%3A//www.w3.org/2000/svg'%3E%3Cpath%20d%3D'M1%204l5%205%205-5'%20stroke%3D'%23007BFF'%20stroke-width%3D'2'%20fill%3D'none'%20stroke-linecap%3D'round'%20stroke-linejoin%3D'round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    form button {
      padding: 10px;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      background-color: #007BFF;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    form button:hover {
      background-color: #0056b3;
    }
    .log-container {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      white-space: pre-wrap;
      margin-top: 10px;
    }
    .transcriptions-container {
      margin-top: 10px;
    }
    .transcription-entry {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .transcription-entry a {
      text-decoration: none;
      color: #007BFF;
    }
    .transcription-entry a:hover {
      text-decoration: underline;
    }
    /* Style for the progress bar card */
    .progress-container {
      text-align: center;
    }
    progress {
      width: 100%;
      max-width: 740px;
      height: 25px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Audio Transcriber</h1>
  </header>
  <div class="container">
    <!-- Upload Card -->
    <div class="card">
      <h2>Upload Audio File</h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <label for="fileInput">Select Audio File</label>
        <input type="file" id="fileInput" name="audioFile" accept="audio/*" required>
        
        <label for="language">Language</label>
        <select id="language" name="language">
          <option value="auto">Auto-detect</option>
          <option value="en">English (en)</option>
          <option value="fr">French (fr)</option>
          <!-- Add additional languages as needed -->
        </select>
        
        <label for="prompt">Prompt (optional)</label>
        <input type="text" id="prompt" name="prompt" placeholder="Enter prompt...">
        
        <button type="submit">Upload for Transcription</button>
      </form>
    </div>

    <!-- Progress Bar Card -->
    <div class="card progress-container">
      <h2>Progress</h2>
      <progress id="progressBar" value="0" max="100"></progress>
      <div id="progressText"></div>
      <div id="timerDisplay" style="margin-top:10px"></div>
    </div>

    <!-- Queue Card -->
    <div class="card">
      <h2>Queue</h2>
      <table id="queueTable" style="width:100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="text-align:left;">Order</th>
            <th style="text-align:left;">File Name</th>
            <th style="text-align:left;">Job ID</th>
            <th style="text-align:left;">Status</th>
          </tr>
        </thead>
        <tbody id="queueBody"></tbody>
      </table>
    </div>
    
    <!-- Available Transcriptions Card -->
    <div class="card">
      <h2>Available Transcriptions</h2>
      <button id="refreshBtn">Refresh Transcriptions</button>
      <table id="transcriptionsTable" style="width:100%; margin-top:10px; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="text-align:left;">File Name</th>
            <th style="text-align:left;">Transcribed On</th>
            <th style="text-align:left;">Download</th>
          </tr>
        </thead>
        <tbody id="transcriptionsBody"></tbody>
      </table>
    </div>

    <!-- Transcription Log Card -->
    <div class="card">
      <h2>Transcription Log</h2>
      <div class="log-container" id="logContainer"></div>
    </div>
  </div>
  
  <script>
    // Function to update the progress bar
    function updateProgressBar(percentage) {
      const progressBar = document.getElementById('progressBar');
      progressBar.value = percentage;
      const progressText = document.getElementById('progressText');
      progressText.textContent = `Progress: ${percentage.toFixed(2)}%`;
    }

    let transcriptionTimer = null;
    let transcriptionStartTime = null;

    // Function to start the timer
    function startTimer() {
      transcriptionStartTime = new Date();
      if (transcriptionTimer) clearInterval(transcriptionTimer);
      transcriptionTimer = setInterval(updateTimerDisplay, 1000);
    }

    // Function to stop the timer
    function stopTimer() {
      if (transcriptionTimer) {
        clearInterval(transcriptionTimer);
        transcriptionTimer = null;
      }
    }

    // Function to update the timer display
    function updateTimerDisplay() {
      if (transcriptionStartTime) {
        const now = new Date();
        const elapsedSeconds = Math.floor((now - transcriptionStartTime) / 1000);
        document.getElementById("timerDisplay").textContent = `Elapsed time: ${elapsedSeconds} s`;
      }
    }

    let transcriptionQueue = [];

    // Function to update the queue UI
    function updateQueueUI() {
      const tbody = document.getElementById('queueBody');
      tbody.innerHTML = '';
      transcriptionQueue.forEach((entry, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${entry.fileName}</td>
          <td>${entry.jobId}</td>
          <td>${entry.status}</td>
        `;
        tbody.appendChild(row);
      });
    }
    
    // Function to add a log entry with timestamp
    function addLogEntry(message, timestamp = null) {
      // If message is a JSON string, attempt to extract only the message field.
      try {
        if (typeof message === 'string' && message.trim().startsWith('{') && message.trim().endsWith('}')) {
          const parsed = JSON.parse(message);
          if (parsed && parsed.message) {
            message = parsed.message;
          }
        }
      } catch (e) {
        console.error("Error parsing message in addLogEntry:", e);
      }
      const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      logEntry.textContent = `[${time}] ${message}`;
      const logContainer = document.getElementById('logContainer');
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // Function to add a transcription entry for downloads
    function addTranscriptionRow(entry) {
      const tbody = document.getElementById('transcriptionsBody');
      const row = document.createElement('tr');
      
      // Convert epoch time to a human-readable format
      const date = new Date(entry.transcribed_on * 1000).toLocaleString();

      row.innerHTML = `
        <td>${entry.original_filename}</td>
        <td>${date}</td>
        <td><a href="${entry.download_url}" download>Download</a></td>
      `;
      tbody.appendChild(row);
    }

    // Function to load transcriptions from backend
    function loadTranscriptions() {
        fetch('http://localhost:8000/transcriptions')
          .then(response => {
            if (!response.ok) {
              throw new Error(`Server responded with status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            const tbody = document.getElementById('transcriptionsBody');
            tbody.innerHTML = ''; // Clear current rows
            if (data.length === 0) {
              addLogEntry("No transcriptions available yet.");
            } else {
              data.forEach(entry => {
                addTranscriptionRow(entry);
              });
            }
          })
          .catch(error => {
            addLogEntry(`ERROR: Could not load transcriptions - ${error.message}`);
          });
      }
    
    loadTranscriptions();
    document.getElementById('refreshBtn').addEventListener('click', loadTranscriptions);
    
    // WebSocket initialization for real-time progress updates
    function initWebSocket() {
      const ws = new WebSocket('ws://127.0.0.1:8000/ws');
      
      ws.onopen = () => {
        addLogEntry('WebSocket connection established');
      };
      
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'update') {
            // Reset progress bar and start timer when a new transcription starts.
            if (data.message.toLowerCase().includes("transcription started")) {
              updateProgressBar(0);
              startTimer();
              // Extract file ID from message "Transcription started for <fileId>_<filename>"
              const parts = data.message.split("for ");
              if (parts.length > 1) {
                const filePart = parts[1].trim();
                const fileIdFromUpdate = filePart.split("_")[0];
                // Update queue entry status for matching fileId
                transcriptionQueue = transcriptionQueue.map(entry => 
                  entry.fileId === fileIdFromUpdate ? { ...entry, status: "transcribing" } : entry
                );
                updateQueueUI();
              }
            }
            // When transcription finishes, stop timer and remove the first (active) entry.
            if (data.message.toLowerCase().includes("transcription finished")) {
              stopTimer();
              transcriptionQueue.shift();
              updateQueueUI();
            }
            // (Existing code for progress bar updates and addLogEntry follows.)
            const regex = /Chunk\s+(\d+)\/(\d+)/;
            const match = regex.exec(data.message);
            if (match) {
              const current = parseInt(match[1]);
              const total = parseInt(match[2]);
              const percent = (current / total) * 100;
              updateProgressBar(percent);
            }
            addLogEntry(data.message, data.timestamp);
          } else if (data.type === 'history') {
            data.messages.reverse().forEach(msg => addLogEntry(msg.message, msg.timestamp));
          } else {
            addLogEntry(data.message || event.data);
          }
        } catch (e) {
          addLogEntry(event.data);
          console.error('Error in onmessage handler:', e);
        }
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        addLogEntry('ERROR: WebSocket connection error');
      };
      
      ws.onclose = (event) => {
        addLogEntry(`WebSocket connection closed: ${event.code}`);
      };
      
      return ws;
    }
    
    let socket = initWebSocket();
    
    // Handle file upload form submission
    document.getElementById('uploadForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const fileInput = document.getElementById('fileInput');
      if (fileInput.files.length === 0) {
        addLogEntry('ERROR: Please select a file.');
        return;
      }
      const file = fileInput.files[0];
      addLogEntry(`Uploading file: ${file.name} (${Math.round(file.size / 1024)} KB)`);
      const formData = new FormData();
      formData.append('audioFile', file);
      
      const language = document.getElementById('language').value || "auto";
      const prompt = document.getElementById('prompt').value || "";
      formData.append('language', language);
      formData.append('prompt', prompt);
      
      fetch('http://localhost:8000/upload', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        addLogEntry(`File uploaded successfully. Job ID: ${data.jobId}`);
        addLogEntry('Waiting for transcription to begin');
        // Add new queue entry on file upload
        transcriptionQueue.push({
          fileName: file.name,
          jobId: data.jobId,
          fileId: data.fileId,
          status: "queued"
        });
        updateQueueUI();
      })
      .catch(error => {
        console.error('Upload error:', error);
        addLogEntry(`ERROR: Upload failed - ${error.message}`);
      });
    });
  </script>
</body>
</html>
